---
title: "temp3"
author: "Stavros Oikonomou"
date: "11/16/2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---



```{r libraries, include=FALSE}
rm(list = ls(all=TRUE))
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

# usage
packages <- c("readxl", "pracma", "chron", "dplyr", "reshape2", "tidyr", 
              "data.table","plyr","data.table","knitr","Hmisc","nortest",
              "ggplot2","sjPlot","tidyverse","lubridate", "tableone", 
              "lme4","reshape","corrplot", "xts","forcats","ggpubr")

ipak(packages)
```

```{r creating the two group vector, include=FALSE}
# Loading the file with the group information
group <- read.csv("Recruitment Management Form-use in R.csv", sep=";")
group <- group[,1:2] # removing anything except code and group
group <- group[-c(15,26,30,39),] # removing this participants
group_1 <- filter(group, Group=="1")
group_2 <- filter(group,Group=="2")

part_g1 <- group_1$Code
part_g2 <- group_2$Code

rm(group, group_1, group_2)
```


```{r loading the dataset,  include=FALSE}
############ READING THE DATA #################

#reading all the data 
# write path for sensors data
path = "D:/MACHINE LEARNING/projects/temp/new/"

# create list of sensors data files
files <- list.files(path, pattern = ".csv")
# read first file of the list
DF <-  read.csv(paste0(path,files[1]), header=T, sep=";")
# add filename as a column in the first sensor data file
DF$FILENAME<-as.character(files[1])

# read each sensor data file and append them to create one file
for (f in files[-1]){
  df <- read.csv(paste0(path,f), header=T, sep=";")      # read the file
  df$FILENAME<-as.character(f)                        # add filename as column
  DF <- rbind(DF, df)                                   # append the current file
}

# fixing entries for T42-S1. He has index for every second and values every 30 sec.
T42_S1 <- DF[DF$FILENAME=="T42_S1new.csv",]
T42_S1 <- T42_S1[!is.na(T42_S1$Temperature),]
T42_S1 <- T42_S1[seq(1,2880,2),]


DF <- DF[DF$FILENAME!="T42_S1new.csv",]


# deleting the 1441st entry 
DF<- DF %>% 
  group_by(FILENAME) %>% 
  slice(1:1440)

DF <- rbind(DF,T42_S1)

# remove rows with no values for temperature
DF <- DF %>%
  filter(!is.na(Temperature)) 

#Seperate the Date variable into 2 other "Date" and "Time"
tempdata1<-tidyr::separate(DF, Date, c("Date", "Time"), sep = "--")

# create Code variable by deleting 7 characters from FILENAME
# FILENAME needs to be character
tempdata1$FILENAME<-as.character(tempdata1$FILENAME)
tempdata1$Code<- substr(tempdata1$FILENAME, 
                        start=1,
                        stop=nchar(tempdata1$FILENAME)-10)

# create order variable by starting from position 6 and deleting 4 characters from FILENAME
tempdata1$order<- substr(tempdata1$FILENAME, 
                         start=5,
                         stop=nchar(tempdata1$FILENAME)-7)

# create temp type variable (air (a) or skin(s)) by starting from position 5 
# and deleting 5 characters from FILENAME
tempdata1$temp_type<- substr(tempdata1$FILENAME, 
                             start=5,
                             stop=nchar(tempdata1$FILENAME)-8)

## create Code_order variable by merging Code and order variables 
tempdata1$Code_order <- paste(tempdata1$Code, tempdata1$order, sep = "-")

# convert Code_order and Code to factors
tempdata1[, c("Code_order", "Code")]<-lapply(
  tempdata1[, c("Code_order", "Code")],
  factor)

# create subset with variables needed only: date, temperature, activity, code_order
tempdata<-subset(tempdata1, select=c(Code, Code_order, order, Date,Time, 
                                     Temperature, temp_type,Activity)) 
rm(tempdata1,DF, df,T42_S1)
```

```{r,include=FALSE}
# we gonna set 1==urban area and 2==rural area
# group 1 participants start from city and then go to mountain

tempdata_1 <- tempdata %>% filter(Code %in% part_g1)
tempdata_1$settings <- ifelse(tempdata_1$order %in% c("A1","S1"),"1","2")
tempdata_1$Group <- "1"

tempdata_2 <- tempdata %>% filter(Code %in% part_g2)
tempdata_2$settings <- ifelse(tempdata_2$order %in% c("A1","S1"),"2","1")
tempdata_2$Group <- "2"

tempdata_final <- rbind(tempdata_1,tempdata_2)
tempdata_final$order <- paste0(tempdata_final$temp_type,tempdata_final$settings)
tempdata_final$Code_order <- paste(tempdata_final$Code, tempdata_final$order, sep = "-")

rm(tempdata_1,tempdata_2,tempdata)
```

```{r reading the data and removing temperature below 34, include=FALSE}
# create a subset with skintemp and airtemp data only
data_skin<-tempdata_final[which(tempdata_final$temp_type == "S"),]
data_air<-tempdata_final[which(tempdata_final$temp_type == "A"),]

data_skin <- subset(data_skin, Temperature>=30)
```

```{r, include=F}
### adding BMI and Age
bmiage <- read.csv("Chronotype_Revised_Theo.csv")
bmiage <- bmiage %>% select(1,3:6) %>% mutate(BMI=round(Weight/(Height/100)^2),2) %>% select(1:3,6)
bmiage$Sex <- as.factor(bmiage$Sex)
bmiage$Sex <- ifelse(bmiage$Sex=="1","Female","Male")
```

```{r creating the diary and activity diary, include=FALSE}
#reading the diary that includes 4 wide categories (indoor,outdoor, unspecified, indoor_ac)
diary<- read.csv("rdiaryfinal.csv", header=T, sep=";", na.strings=c("","NA"))
diary_1 <- diary %>% filter(ID %in% part_g1)
diary_2 <- diary %>% filter(ID %in% part_g2)
diary_2$Setting <- ifelse(diary_2$Setting=="1","2","1")
diary <- rbind(diary_1,diary_2)

# create subsets according to the setting (4 subset skin/air sensors in each setting)
diaryskin_set1<-diary [which(diary$Setting == "1"),]
diaryskin_set2<-diary [which(diary$Setting == "2"),]
diaryair_set1<-diary [which(diary$Setting == "1"),]
diaryair_set2<-diary [which(diary$Setting == "2"),]

# in order to merge the diary to the four different datasets that we will create (one for peaks one for troughs in each setting)
# we create a new variable Code_order by merging the ID col with Setting variables and seperate them 
#by 'S-' for skin data 
diaryskin_set1$Code_order <- paste(diaryskin_set1$ID, diaryskin_set1$Setting, sep = "-S")                 
diaryskin_set2$Code_order <- paste(diaryskin_set2$ID, diaryskin_set2$Setting, sep = "-S")         
diaryair_set1$Code_order <- paste(diaryair_set1$ID, diaryair_set1$Setting, sep = "-A")                 
diaryair_set2$Code_order <- paste(diaryair_set2$ID, diaryair_set2$Setting, sep = "-A")         

#removing the two first columns (ID, Setting) 
diaryair_set1<-select (diaryair_set1, -c(ID, Setting))
diaryair_set2<-select (diaryair_set2, -c(ID, Setting))
diaryskin_set1<-select (diaryskin_set1, -c(ID, Setting))
diaryskin_set2<-select (diaryskin_set2, -c(ID, Setting))

#reading the diary that includes all activities (wake_up, sleep, housekeeping, being_at_work, driving, etc)
diary_activities<- read.csv("diaryfinal.csv", header=T, sep=";", na.strings=c("","NA"))
diary_activities_1 <- diary_activities %>% filter(ID %in% part_g1)
diary_activities_2 <- diary_activities %>% filter(ID %in% part_g2)
diary_activities_2$Setting <- ifelse(diary_activities_2$Setting=="1","2","1")
diary_activities <- rbind(diary_activities_1,diary_activities_2)


# create subsets according to the setting (4 subset skin/air sensors in each setting)
adiaryskin_set1<-diary_activities [which(diary_activities$Setting == "1"),]
adiaryskin_set2<-diary_activities [which(diary_activities$Setting == "2"),]
adiaryair_set1<-diary_activities [which(diary_activities$Setting == "1"),]
adiaryair_set2<-diary_activities [which(diary_activities$Setting == "2"),]

# in order to merge the diary to the four different datasets that we will create (one for peaks one for troughs in each setting)
# we create a new variable Code_order by merging the ID col with Setting variables and seperate them 
#by 'S-' for skin data 
adiaryskin_set1$Code_order <- paste(adiaryskin_set1$ID, adiaryskin_set1$Setting, sep = "-S")                 
adiaryskin_set2$Code_order <- paste(adiaryskin_set2$ID, adiaryskin_set2$Setting, sep = "-S")         
adiaryair_set1$Code_order <- paste(adiaryair_set1$ID, adiaryair_set1$Setting, sep = "-A")                 
adiaryair_set2$Code_order <- paste(adiaryair_set2$ID, adiaryair_set2$Setting, sep = "-A")         

#removing the two first columns (ID, Setting) 
adiaryair_set1<-select (adiaryair_set1, -c(ID, Setting))
adiaryair_set2<-select (adiaryair_set2, -c(ID, Setting))
adiaryskin_set1<-select (adiaryskin_set1, -c(ID, Setting))
adiaryskin_set2<-select (adiaryskin_set2, -c(ID, Setting))

rm(diary_1,diary_2,diary_activities_1,diary_activities_2)

```


```{r, include=FALSE}
# read data
basic<-read.csv(file="Recruitment Management Form-use in R.csv", header=T, sep=";")
# str(basic)
baseline<-read.csv(file="Demographics.csv", header=T, sep=";")
# str(baseline)
chrono<-read.csv(file="Chronotype_Revised_Theo.csv", header=T, sep=",")
# str(chrono)

# rename the code column to Code
colnames(chrono)[colnames(chrono) == '?.?Code'] <- 'Code'

# merge the 3 dataframes by Code
mergeddata_in<-Reduce(function(x, y) merge(x, y, all=TRUE, by="Code"),
               list(baseline, basic, chrono))

# change variable types into factors
mergeddata_in[, c("Group","education_level","Smoking_status", "alcohol_freq",
               "Physical_exercise","Travel_last_3_months", "Flight_frequency","Sex",
               "Regular_work_schedule", "WD_alarm_on", "WD_awake_before_alarm",
           "FD_alarm_on", "nofree_sleep_time", "children_Pets","Hobbies",
           "Shift_worker","Schedule_type","Cig_frequency","Beer_frequency",
           "Wine_frequency","Liquor_frequency","Coffee_frequency","Tea_frequency",
           "Caffeine_frequency")]<-lapply(
mergeddata_in[, c("Group","education_level","Smoking_status","alcohol_freq",
               "Physical_exercise","Travel_last_3_months","Flight_frequency","Sex",
               "Regular_work_schedule", "WD_alarm_on", "WD_awake_before_alarm",
           "FD_alarm_on", "nofree_sleep_time","children_Pets","Hobbies",
           "Shift_worker","Schedule_type","Cig_frequency","Beer_frequency",
           "Wine_frequency","Liquor_frequency","Coffee_frequency","Tea_frequency",
           "Caffeine_frequency")],
             factor)

# format dates
mergeddata_in[, c("First_day_in_village", "Last_day_in_village",
                  "First_Sampling_day","Second_Sampling_day")]<-lapply(
mergeddata_in[, c("First_day_in_village", "Last_day_in_village",
                  "First_Sampling_day","Second_Sampling_day")],
             as.Date, format="%d/%m/%Y")

# calculate BMI based on formula: weight/height(m)^2
mergeddata_in$BMI<-mergeddata_in$Weight/((mergeddata_in$Height/100)^2)

# create BMI categories:
# underweight under 18.5 kg/m2, normal weight: 18.5 to 25, overweight: 25 to 30
mergeddata_in$BMIcat <- cut(mergeddata_in$BMI,
                      breaks=c(-Inf, 18.5, 25, 30, +Inf),
                      labels=c("underweight","normal weight","overweight","obese"))

# create chronotype categories:
# early (<3:00), intermediate (3:00?5:00) and late (>5:00)
# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5479630/,
# https://onlinelibrary.wiley.com/doi/full/10.1111/j.1479-8425.2012.00541.x

x=as.POSIXct(strptime(c("000000","030000","050000","235959"),
                      "%H%M%S"),"UTC")
mergeddata_in$Chronotype1 <- as.POSIXct(strptime((mergeddata_in$Chronotype),"%H:%M"),"UTC")

labs=c("early","intermediate","late")
mergeddata_in$Chronotypecat <-labs[findInterval(mergeddata_in$Chronotype1,x)]
mergeddata_in$Chronotypecat <-as.factor(mergeddata_in$Chronotypecat)

# revalue categorical variables to their actual values:

mergeddata_in$Group <- revalue(mergeddata_in$Group, c("1"="First urban", "2"="First mountainous"))
mergeddata_in$education_level <- revalue(mergeddata_in$education_level,
                                    c("2"="Secondary",
                                      "3"="University/college",
                                      "4"="Master/PhD"))
mergeddata_in$Smoking_status <- revalue(mergeddata_in$Smoking_status,
                                    c("1"="Smoker", "2"="Non-smoker",
                                      "3"="Former smoker"))
mergeddata_in$alcohol_freq <- revalue(mergeddata_in$alcohol_freq,
                                        c("2"="Weekly",
                                          "3"="Monthly","4"="Rarely/Never"))
mergeddata_in$Physical_exercise <- revalue(mergeddata_in$Physical_exercise,
                                        c("1"="Yes", "2"="No"))
mergeddata_in$Travel_last_3_months <- revalue(mergeddata_in$Travel_last_3_months,
                                        c("1"="Yes", "2"="No"))
mergeddata_in$Flight_frequency <- revalue(mergeddata_in$Flight_frequency,
                                        c("1"="Every month", "2"="Every 3 months",
                                          "3"="Irregular"))
mergeddata_in$Sex <- revalue(mergeddata_in$Sex, c("1"="Female", "2"="Male"))
mergeddata_in$Regular_work_schedule <- revalue(mergeddata_in$Regular_work_schedule,
                                        c("1"="Yes", "2"="No", "9"=NA))
mergeddata_in$nofree_sleep_time <- revalue(mergeddata_in$nofree_sleep_time,
                                        c("1"="Yes", "2"="No", "9"=NA))
mergeddata_in$Shift_worker <- revalue(mergeddata_in$Shift_worker,
                                        c("1"="Yes", "2"="No"))
mergeddata_in$Schedule_type <- revalue(mergeddata_in$Schedule_type,
                                        c("1"="Very flexible", "2"="A little flexible",
                                          "3"="Rather inflexible", "4"="Very inflexible"))


# calculate washout period based on group
# for Group 2: use of 5 days in order to account the first day in urban setting
mergeddata_in$washout_days<-ifelse(
  mergeddata_in$Group=="First mountainous",
  mergeddata_in$Second_Sampling_day - 5 - mergeddata_in$Last_day_in_village,
  ifelse(mergeddata_in$Group=="First urban",
           mergeddata_in$First_day_in_village - mergeddata_in$First_Sampling_day,
         NA))

# calculate days in village based on group
mergeddata_in$days_mountain<-ifelse(
  mergeddata_in$Group=="First mountainous",
  mergeddata_in$First_Sampling_day - mergeddata_in$First_day_in_village,
  ifelse(mergeddata_in$Group=="First urban",
           mergeddata_in$Second_Sampling_day - mergeddata_in$First_day_in_village,
         NA))


# variable selection for basic demographic characteristics
selectionDescr<-c("Age","Sex","BMI","BMIcat",
                  "education_level","Chronotypecat", "Smoking_status",
                  "alcohol_freq","Physical_exercise","screen_hours_day",
                  "days_mountain","washout_days")

categorvariablesDescr<-c("Sex","BMIcat",
                         "education_level","Smoking_status","alcohol_freq",
                         "Chronotypecat","Physical_exercise")
mergeddata <- subset(mergeddata_in,
                     !(mergeddata_in$Code == "T25"|        # no data
                       mergeddata_in$Code == "T44"|
                         mergeddata_in$Code == "T50"|
                         mergeddata_in$Code == "T65"))        # no data

rm(basic,baseline,chrono,mergeddata_in)
```
### Table 1 - Baseline characteristics - Study participants (overall and by group)

`r kable(print(CreateTableOne(selectionDescr, data=mergeddata, factorVars=categorvariablesDescr)), caption="Baseline characteristics of participants")`

`r kable(print(CreateTableOne(selectionDescr, data=mergeddata, factorVars=categorvariablesDescr, strata="Group")),caption="Baseline characteristics of participants by group")`

### Summary table for ambient air temperature by setting taking in account all observations

`r kable(print(CreateTableOne("Temperature", data=data_air, strata="settings"),testNonNormal = kruskal.test, nonnormal = "Temperature"), caption="Summary table of ambient air temperature by setting")`

### Summary table for skin temperature by setting taking in account all observations

`r kable(print(CreateTableOne("Temperature", data=data_skin, strata="settings"),testNonNormal = kruskal.test, nonnormal = "Temperature"), caption="Summary table of skin temperature by setting")`

### Summary table of cumulative activity by settting based on skin sensors

`r kable(print(CreateTableOne("Activity", data=data_skin, strata="settings"),testNonNormal = kruskal.test, nonnormal = "Activity"), caption="Summary table of cumulative activity per day based on skin sensors") `

```{r}
ggplot(data_air, aes(x=Code_order, y=Temperature, fill=settings)) + geom_boxplot()
```

```{r}
ggplot(data_skin, aes(x=Code_order, y=Temperature, fill=settings)) + geom_boxplot()
```

```{r, echo=F, message=FALSE, warning=FALSE}
diary_t <- diary[,3:1442]
diary_t <- t(diary_t)
diary_t <- data.frame(diary_t)
indoor_counter <- vector()
for(i in 1:ncol(diary_t)){
  indoor_counter[i] <- length(diary_t[diary_t[,i] %in% c("indoor_activities","indoor_activities ") & !is.na(diary_t[,i]) ,i]) 
}

outdoor_counter <- vector()
for(i in 1:ncol(diary_t)){
  outdoor_counter[i] <- length(diary_t[diary_t[,i] %in% c("outdoor_activities","outdoor_activities ") & !is.na(diary_t[,i]) ,i])
}

counter <- vector()
for(i in 1:ncol(diary_t)){counter[i]<- sum(diary_t[,i] %in% c("indoor_activities","indoor_activities ","outdoor_activities","outdoor_activities "))}



prop_table <- data.frame(indoor=round(indoor_counter/counter,2),outdoor=round(outdoor_counter/counter,2))
#knitr::kable(prop_table)
hist(prop_table$indoor)
prop_table2 <- melt(prop_table)
```

### Summary table of proportion of Indoor/Outdoor

`r kable(print(CreateTableOne("value", data=prop_table2, strata="variable"),testNonNormal = kruskal.test, nonnormal = "value"), caption="Summary table of proportion of Indoor/Outdoor")`

```{r threshold, include=FALSE}
plot_peak_count <- function(Code_order,threshold,data){
  x <- data[which(data$Code_order == Code_order),]
  x$Index1<-1:nrow(x)
  loessMod5 <- loess(x$Temperature~Index1, data=x, span=0.1) # 10% smoothing span
  x$smoothed5 <- predict(loessMod5) 
  
  pp <- findpeaks (x$smoothed5, nups = 1, ndowns = 0, minpeakheight = 0, 
                   minpeakdistance = 1, threshold = threshold, npeaks = 0, sortstr = FALSE)
  data.peaks<-data.frame(data.smoothed5=pp)
  z<<-nrow(data.peaks)
  return(z)
}

co_listA <- c("T10-A1","T11-A1","T12-A1","T13-A1","T14-A1","T15-A1","T16-A1",
              "T17-A1","T18-A1","T19-A1","T21-A1","T22-A1","T23-A1","T24-A1",
              "T26-A1","T29-A1","T31-A1","T33-A1","T34-A1","T35-A1","T37-A1",
              "T38-A1","T46-A1","T47-A1","T51-A1","T52-A1","T53-A1","T56-A1",
              "T60-A1","T61-A1","T64-A1","T66-A1","T67-A1","T10-A2","T11-A2",
              "T12-A2","T16-A2","T17-A2","T18-A2","T19-A2","T24-A2","T26-A2",
              "T35-A2","T37-A2","T38-A2","T42-A2","T43-A2","T45-A2","T60-A2",
              "T42-A1","T54-A1","T45-A1")

co_listS <- c("T10-S1","T11-S1","T12-S1","T13-S1","T14-S1","T15-S1","T16-S1",
              "T18-S1","T19-S1","T21-S1","T22-S1","T23-S1","T24-S1","T26-S1",
              "T29-S1","T31-S1","T33-S1","T34-S1","T35-S1","T37-S1","T38-S1",
              "T45-S1","T46-S1","T47-S1","T51-S1","T52-S1","T53-S1","T56-S1",
              "T60-S1","T61-S1","T64-S1","T66-S1","T67-S1","T10-S2","T11-S2",
              "T12-S2","T16-S2","T17-S2","T24-S2","T26-S2","T29-S2","T31-S2",
              "T33-S2","T34-S2","T35-S2","T38-S2","T43-S2","T45-S2","T60-S2")
```

```{r air threshold, include=FALSE}
a01 <- vector()
for(i in co_listA){
  k <- plot_peak_count(i,0.1,data_air)
  a01 <- append(a01,k)
}

a02 <- vector()
for(i in co_listA){
  k <- plot_peak_count(i,0.2,data_air)
  a02 <- append(a02,k)
}

a03 <- vector()
for(i in co_listA){
  k <- plot_peak_count(i,0.3,data_air)
  a03 <- append(a03,k)
}

a04 <- vector()
for(i in co_listA){
  k <- plot_peak_count(i,0.4,data_air)
  a04 <- append(a04,k)
}

a05 <- vector()
for(i in co_listA){
  k <- plot_peak_count(i,0.5,data_air)
  a05 <- append(a05,k)
}


a06 <- vector()
for(i in co_listA){
  k <- plot_peak_count(i,0.6,data_air)
  a06 <- append(a06,k)
}

a07 <- vector()
for(i in co_listA){
  k <- plot_peak_count(i,0.7,data_air)
  a07 <- append(a07,k)
}

thrs_A <- rbind.data.frame(a01,a02,a03,a04,a05,a06,a07)
names(thrs_A) <- co_listA


thrs_AM1 <- apply(thrs_A,1, median)
```

```{r, include=FALSE}
t01 <- vector()
for(i in co_listS){
  k <- plot_peak_count(i,0.1,data_skin)
  t01 <- append(t01,k)
}

t02 <- vector()
for(i in co_listS){
  k <- plot_peak_count(i,0.2,data_skin)
  t02 <- append(t02,k)
}

t03 <- vector()
for(i in co_listS){
  k <- plot_peak_count(i,0.3,data_skin)
  t03 <- append(t03,k)
}

t04 <- vector()
for(i in co_listS){
  k <- plot_peak_count(i,0.4,data_skin)
  t04 <- append(t04,k)
}

t05 <- vector()
for(i in co_listS){
  k <- plot_peak_count(i,0.5,data_skin)
  t05 <- append(t05,k)
}


t06 <- vector()
for(i in co_listS){
  k <- plot_peak_count(i,0.6,data_skin)
  t06 <- append(t06,k)
}

t07 <- vector()
for(i in co_listS){
  k <- plot_peak_count(i,0.7,data_skin)
  t07 <- append(t07,k)
}

thrs_S <- rbind.data.frame(t01,t02,t03,t04,t05,t06,t07)
names(thrs_S) <- co_listS


thrs_SM1 <- apply(thrs_S,1, median)
```

```{r}
thrs_AM <- data.frame("threshold"=seq(0.1,0.7,0.1), "peaks"=thrs_AM1)
ggplot(thrs_AM, aes(x=threshold,y=peaks)) + geom_line() + geom_point(size=3, colour="red") + ggtitle("threshold sensitivity analysis on number of peaks for Air sensor") + 
  theme_classic() + scale_x_continuous(breaks = seq(0.1,0.7,0.1))

thrs_SM <- data.frame("threshold"=seq(0.1,0.7,0.1), "peaks"=thrs_SM1)
ggplot(thrs_SM, aes(x=threshold,y=peaks)) + geom_line() + geom_point(size=3, colour="red") + ggtitle("threshold sensitivity analysis on number of peaks for Skin sensor") + 
  theme_classic() + scale_x_continuous(breaks = seq(0.1,0.7,0.1))
```
```{r, include=FALSE}
rm(thrs_A,thrs_AM,thrs_AM1,thrs_S,thrs_SM,thrs_SM1)
```

```{r, include=FALSE}
 #### using activity groups
 ######function to find the peaks

peaks <- function(Code_order,data,set){
  x <- data[which(data$Code_order == Code_order),]
  x$Index1<-1:nrow(x)
  
  #merge the diary data 
  #diary data has only the participants' code and setting, not the type of the sensor
  #in order to merge the diary with the air/skin sensors we create two subsets-dataframes 
  y<-set[which(set$Code_order == Code_order),]
  y<-data.frame(t(y))
  
  #rename X1 to P_location
  names(y)="X1"<-"Location"

  #create another variable Index1 to be able to merge sensors data with diary data by it. (Index1 refers to time)
  y$Index1<-1:nrow(y)
  x<-merge(x = x, y = y, by = "Index1", all = TRUE)
  x<-x[!(is.na(x$Temperature)) , ]
  #smoothed the linegraph
  loessMod5 <- loess(x$Temperature~Index1, data=x, span=0.1) # 10% smoothing span
  x$smoothed5 <- predict(loessMod5) 
  #plot(x$Temperature, x=x$Index1, type="l", main="Loess Smoothing and Prediction", 
    #   xlab="Date", ylab="Temperature")
  #lines(x$smoothed5, x=x$Index1, col="red")
  
  #find peaks 
  pp <- findpeaks (x$smoothed5, nups = 1, ndowns = 0, minpeakheight = 0, minpeakdistance = 1, 
                   threshold = 0.2, npeaks = 0, sortstr = FALSE)
  
  #create the plot with the smoothed data and peaks/troughs
  plot(x$smoothed5, type = 'l',main=paste("Peaks of",Code_order))
  points(pp,x$smoothed5[pp], col = 'red', pch = 19)
  
  #create a data frame showing the location of peaks/troughs  
  data.peaks=data.frame(data.smoothed5=pp)
  
  #number of peaks
  peaks1<-subset(data.peaks, select = data.smoothed5.2)
  names(peaks1)='data.smoothed5.2'<- 'peaks'
  
  #find the sum of the peaks
  peaks1$pnum_p<-nrow(peaks1)
  #keep only one value for the sum to have a dataframe with 1 obs and 10 variables
  peaks1<-setDT(peaks1)[, head(.SD,1)]
  
  #moving the sum of peaks into a new dataframe
  numpeaks_skin<-subset(peaks1, select=pnum_p)
  
  #create dataset with temp values only and rename the variable 
  z<-subset(data.peaks, select = c(data.smoothed5.1))
  names(z)="data.smoothed5.1"<-"peaks"
  
  #matching the temp values with the original dataset to find the time of peaks
  d1 <- data.table(z, key = 'peaks')
  d2 <- data.table(x, key = 'smoothed5')
  peaks1<-d2[d1]
  
  #create subset and rename the col names
  z<-subset(peaks1, select=c(Code_order, smoothed5, Time, Location, Date))
  names(z)[2] = "smoothed5" <- "P_temperature"
  names(z) [3]= "Time"<- "P_time"
  names(z) [4]= "Location"<- "P_location"
  names(z) [5]= "Date"<- "P_date"
  
  df2p <- within(z, count <- ave(rep(1,nrow(z)),z$Code_order,FUN=cumsum))
  #df2p<-reshape(df2p,direction="wide",idvar="Code_order",timevar="count") 
  
  return(df2p)
}



tnum_a1 <- c("T10-A1","T11-A1","T12-A1","T13-A1","T14-A1","T15-A1","T16-A1","T17-A1","T18-A1",
             "T19-A1","T21-A1","T22-A1","T23-A1","T24-A1","T26-A1","T29-A1","T31-A1","T33-A1",
             "T34-A1","T35-A1","T37-A1","T38-A1","T46-A1","T47-A1","T51-A1","T52-A1","T53-A1",
             "T56-A1","T60-A1","T61-A1","T64-A1","T66-A1","T67-A1")

tnum_a2 <- c("T10-A2","T11-A2","T12-A2","T16-A2","T17-A2","T18-A2","T19-A2","T24-A2",
             "T26-A2","T35-A2","T37-A2","T38-A2","T42-A2","T43-A2","T45-A2","T60-A2")

tnum_s1 <- c("T10-S1","T11-S1","T12-S1","T13-S1","T14-S1","T15-S1","T16-S1","T18-S1","T19-S1",
             "T21-S1","T22-S1","T23-S1","T24-S1","T26-S1","T29-S1","T31-S1","T33-S1","T34-S1",
             "T35-S1","T37-S1","T38-S1","T45-S1","T46-S1","T47-S1","T51-S1","T52-S1","T53-S1",
             "T56-S1","T60-S1","T61-S1","T64-S1","T66-S1","T67-S1")
             
tnum_s2 <- c("T10-S2","T11-S2","T12-S2","T16-S2","T17-S2","T24-S2","T26-S2","T29-S2",
             "T31-S2","T33-S2","T34-S2","T35-S2","T38-S2","T43-S2","T45-S2","T60-S2")
```

```{r finding the peaks and creating the plots, include=F}
peaks_air1 <- data.frame()
for(i in tnum_a1){
  dff <- peaks(i,data_air,diaryair_set1)
  peaks_air1 <- rbind.fill(peaks_air1,dff)
}

peaks_air2 <- data.frame()
for(i in tnum_a2){
  dff <- peaks(i,data_air,diaryair_set2)
  peaks_air2 <- rbind.fill(peaks_air2,dff)
}
peaks_air2[46,4]<- "outdoor_activities"

peaks_air_all <- rbind.fill(peaks_air1,peaks_air2)

peaks_skin1 <- data.frame()
for(i in tnum_s1){
  dff <- peaks(i,data_skin,diaryskin_set1)
  peaks_skin1 <- rbind.fill(peaks_skin1,dff)
}

peaks_skin2 <- data.frame()
for(i in tnum_s2){
  dff <- peaks(i,data_skin,diaryskin_set2)
  peaks_skin2 <- rbind.fill(peaks_skin2,dff)
}

peaks_skin_all <- rbind.fill(peaks_skin1,peaks_skin2)
rm(dff)
```

```{r, include=F}
apeaks_air1 <- data.frame()
for(i in tnum_a1){
  dff <- peaks(i,data_air,adiaryair_set1)
  apeaks_air1 <- rbind.fill(apeaks_air1,dff)
}

apeaks_air2 <- data.frame()
for(i in tnum_a2){
  dff <- peaks(i,data_air,adiaryair_set2)
  apeaks_air2 <- rbind.fill(apeaks_air2,dff)
}

apeaks_air_all <- rbind.fill(apeaks_air1,apeaks_air2)

apeaks_skin1 <- data.frame()
for(i in tnum_s1){
  dff <- peaks(i,data_skin,adiaryskin_set1)
  apeaks_skin1 <- rbind.fill(apeaks_skin1,dff)
}

apeaks_skin2 <- data.frame()
for(i in tnum_s2){
  dff <- peaks(i,data_skin,adiaryskin_set2)
  apeaks_skin2 <- rbind.fill(apeaks_skin2,dff)
}

apeaks_skin_all <- rbind.fill(apeaks_skin1,apeaks_skin2)
```

```{r, include=FALSE}
######function

ffunc <- function(Code_order,data,set){
  x <- data[which(data$Code_order == Code_order),]
  x$Index1<-1:nrow(x)
  
  #merge the diary data 
  #diary data has only the participants' code and setting, not the type of the sensor
  #in order to merge the diary with the air/skin sensors we create two subsets-dataframes 
  y<-set[which(set$Code_order == Code_order),]
  y<-data.frame(t(y))
  
  #rename X1 to P_location
  names(y)="X1"<-"Location"

  #create another variable Index1 to be able to merge sensors data with diary data by it. (Index1 refers to time)
  y$Index1<-1:nrow(y)
  x<-merge(x = x, y = y, by = "Index1", all = TRUE)
  x<-x[!(is.na(x$Temperature)) , ]
  #smoothed the linegraph
  loessMod5 <- loess(x$Temperature~Index1, data=x, span=0.1) # 10% smoothing span
  x$smoothed5 <- predict(loessMod5) 
  #plot(x$Temperature, x=x$Index1, type="l", main="Loess Smoothing and Prediction", 
    #   xlab="Date", ylab="Temperature")
  #lines(x$smoothed5, x=x$Index1, col="red")
  
  #find peaks 
  pp <- findpeaks (x$smoothed5, nups = 1, ndowns = 0, minpeakheight = 0, minpeakdistance = 1, 
                   threshold = 0.2, npeaks = 0, sortstr = FALSE)
  
  #create the plot with the smoothed data and peaks/troughs
  #plot(x$smoothed5, type = 'l')
  #points(pp,x$smoothed5[pp], col = 'red', pch = 19)
  
  #create a data frame showing the location of peaks/troughs  
  data.peaks=data.frame(data.smoothed5=pp)
  
  #number of peaks
  peaks1<-subset(data.peaks, select = data.smoothed5.2)
  names(peaks1)='data.smoothed5.2'<- 'peaks'
  
  #find the sum of the peaks
  peaks1$pnum_p<-nrow(peaks1)
  #keep only one value for the sum to have a dataframe with 1 obs and 10 variables
  peaks1<-setDT(peaks1)[, head(.SD,1)]
  
  #moving the sum of peaks into a new dataframe
  numpeaks_skin<-subset(peaks1, select=pnum_p)
  
  #create dataset with temp values only and rename the variable 
  z<-subset(data.peaks, select = c(data.smoothed5.1))
  names(z)="data.smoothed5.1"<-"peaks"
  
  #matching the temp values with the original dataset to find the time of peaks
  d1 <- data.table(z, key = 'peaks')
  d2 <- data.table(x, key = 'smoothed5')
  peaks1<-d2[d1]
  
  #create subset and rename the col names
  z<-subset(peaks1, select=c(Code_order, smoothed5, Time, Location, Date))
  names(z)[2] = "smoothed5" <- "P_temperature"
  names(z) [3]= "Time"<- "P_time"
  names(z) [4]= "Location"<- "P_location"
  names(z) [5]= "Date"<- "P_date"
  
  df2p <- within(z, count <- ave(rep(1,nrow(z)),z$Code_order,FUN=cumsum))
  df2p<-reshape(df2p,direction="wide",idvar="Code_order",timevar="count")
  df2p$peaks<-numpeaks_skin$pnum_p

  return(df2p)
}

```

```{r, include=F}
dff <- data.frame()
final_a1_mix <- data.frame()
for(i in tnum_a1){
  dff <- ffunc(i,data_air,diaryair_set1)
  final_a1_mix <- rbind.fill(final_a1_mix,dff)
}

dff <- data.frame()
final_a2_mix <- data.frame()
for(i in tnum_a2){
  dff <- ffunc(i,data_air,diaryair_set2)
  final_a2_mix <- rbind.fill(final_a2_mix,dff)
}

final_air_mix <- rbind.fill(final_a1_mix,final_a2_mix)

dff <- data.frame()
final_s1_mix <- data.frame()
for(i in tnum_s1){
  dff <- ffunc(i,data_skin,diaryskin_set1)
  final_s1_mix <- rbind.fill(final_s1_mix,dff)
}
final_s1_mix <- final_s1_mix[!is.na(final_s1_mix$Code_order),]


dff <- data.frame()
final_s2_mix <- data.frame()
for(i in tnum_s2){
  dff <- ffunc(i,data_skin,diaryskin_set2)
  final_s2_mix <- rbind.fill(final_s2_mix,dff)
}
final_s2_mix <- final_s2_mix[!is.na(final_s2_mix$Code_order),]

final_skin_mix <- rbind.fill(final_s1_mix,final_s2_mix)

rm(dff)
```

```{r, include=FALSE, eval=FALSE}
raw_location_merge_func <- function(Code_order,data,set){
  x <- data[which(data$Code_order == Code_order),]
  x$Index1<-1:nrow(x)
  
  y<-set[which(set$Code_order == Code_order),]
  y<-data.frame(t(y))
  
  #rename X1 to P_location
  names(y)="X1"<-"Location"
  #create another variable Index1 to be able to merge sensors data with diary data by it. (Index1 refers to time)
  y$Index1<-1:nrow(y)
  x<-merge(x = x, y = y, by = "Index1", all = TRUE)
  x<-x[!(is.na(x$Temperature)) , ]
  #smoothed the linegraph
  loessMod5 <- loess(x$Temperature~Index1, data=x, span=0.1) # 10% smoothing span
  x$smoothed5 <- predict(loessMod5) 
  Code_order <- x
  Code_order <- data.frame(Code_order)
  tn <<- rbind.fill(tn,Code_order)
}
```

```{r, include=FALSE, eval=FALSE}
tn <- data.frame()
air1_loc <- data.frame()
for(i in tnum_a1){
  dff <- raw_location_merge_func(i,data_air,diaryair_set1)
  air1_loc <- rbind.fill(air1_loc,dff)
}
TNUMA1 <- tn

tn <- data.frame()
air2_loc <- data.frame()
for(i in tnum_a2){
  dff <- raw_location_merge_func(i,data_air,diaryair_set2)
  air2_loc <- rbind.fill(air2_loc,dff)
}
TNUMA2 <- tn

TNUMAIR <- rbind(TNUMA1,TNUMA2)

write.csv(TNUMAIR,"TNUMAIR.csv", row.names = F)
```

```{r, include=FALSE, eval=FALSE}
tn <- data.frame()
skin1_loc <- data.frame()
for(i in tnum_s1){
  dff <- raw_location_merge_func(i,data_skin,diaryskin_set1)
  skin1_loc <- rbind.fill(skin1_loc,dff)
}
TNUMS1 <- tn

tn <- data.frame()
skin2_loc <- data.frame()
for(i in tnum_s2){
  dff <- raw_location_merge_func(i,data_skin,diaryskin_set2)
  skin2_loc <- rbind.fill(skin2_loc,dff)
}
TNUMS2 <- tn

TNUMSKIN <- rbind(TNUMS1,TNUMS2)

write.csv(TNUMSKIN,"TNUMSKIN.csv", row.names = F)
```

```{r}
#mean,median,IQR number of peaks/troughs
summary(final_air_mix$peaks)
summary(final_skin_mix$peaks)

#mean,median,IQR values peaks/troughs
summary(peaks_air_all$P_temperature)
summary(peaks_skin_all$P_temperature)

summary(peaks_air1$P_temperature)
summary(peaks_air2$P_temperature)

summary(peaks_skin1$P_temperature)
summary(peaks_skin2$P_temperature)

summary(tempdata_final$Activity)
```


```{r normality test}
#air sensor peaks both settings
qqnorm(peaks_air_all$P_temperature) 
shapiro.test(peaks_air_all$P_temperature)
hist(peaks_air_all$P_temperature)

#skin sensor peaks both settings
qqnorm(peaks_skin_all$P_temperature) 
shapiro.test(peaks_skin_all$P_temperature)
hist(peaks_skin_all$P_temperature)


# qqplot for raw data temperature
ggqqplot(data_air$Temperature)
ggqqplot(data_skin$Temperature)

# number of peaks
qqnorm(final_air_mix$peaks)
hist(final_air_mix$peaks)
hist(final_skin_mix$peaks)


```


```{r}
qqnorm(log(data_air$Temperature))
```
```{r}
qqnorm(log(data_skin$Temperature))
```



```{r}
qqnorm(log(data_air$Activity + 1))
```

```{r}
qqnorm( log(data_skin$Activity + 1))
```

### Anderson-Darling normality test for Air. Shapiro doesn't work for more than 5000 obs
```{r}
ad.test(data_air$Temperature)
```

```{r}
ad.test(data_skin$Temperature)
```



### Boxplot peaks
```{r, echo=FALSE}
set1_air <- as.data.frame(final_a1_mix$peaks)
set1_air$type <- "peaks"
colnames(set1_air)[1]<- "num"
set1_air$set <- "Urban"

set2_air <- as.data.frame(final_a2_mix$peaks)
set2_air$type <- "peaks"
colnames(set2_air)[1]<- "num"
set2_air$set <- "Rural"

air_f <- rbind(set1_air,set2_air)
air_f$sensor <- "Air"

T421<- c(as.numeric("0"), "peaks", "Urban", "Air")
T541<- c(as.numeric("0"), "peaks", "Urban", "Air")
T451<- c(as.numeric("0"), "peaks", "Urban", "Air")
air_f <- rbind(air_f,T421,T541,T451)
air_f$num <- as.numeric(air_f$num)


### skin
set1_skin <- as.data.frame(final_s1_mix$peaks)
set1_skin$type <- "peaks"
colnames(set1_skin)[1]<- "num"
set1_skin$set <- "Urban"

set2_skin <- as.data.frame(final_s2_mix$peaks)
set2_skin$type <- "peaks"
colnames(set2_skin)[1]<- "num"
set2_skin$set <- "Rural"

skin_f <- rbind(set1_skin,set2_skin)
skin_f$sensor <- "Skin"
skin_f$num <- as.numeric(skin_f$num)

#ggplot(data = skin_f, aes(x = type, y = num, fill=type)) +geom_boxplot() +  facet_wrap(~set) + xlab("Skin sensors")


total_f <- rbind(air_f,skin_f)
ggplot(data = total_f, aes(x = type, y = num)) +geom_boxplot() +  facet_grid(sensor~set) + geom_jitter(width = 0.2) +ylab("Number of Peaks")

ggplot(data = total_f, aes(x = type, y = num)) +geom_boxplot(aes(fill=set)) +  facet_grid(sensor~.)
```



# Temperature plots for Location Settings
```{r}
knitr::kable(peaks_air1 %>% group_by(P_location) %>% summarise_each(mean,P_temperature) %>% mutate(Location=P_location,Mean_Temperature=P_temperature) %>% select(Location,Mean_Temperature), caption="Mean Temperature values of peaks for Air Sensors Urban")
```
```{r}
knitr::kable(peaks_air2 %>% group_by(P_location) %>% summarise_each(mean,P_temperature) %>% mutate(Location=P_location,Mean_Temperature=P_temperature) %>% select(Location,Mean_Temperature), caption="Mean Temperature values of peaks for Air Sensors Rural")
```

```{r}
peaks_air1 %>% mutate(P_location= fct_reorder(P_location, P_temperature)) %>%
  filter(!is.na(P_location) & P_location %in% c("indoor_activities","outdoor_activities")) %>%
  ggplot(aes(P_temperature,P_location)) + geom_boxplot() + xlab("Temperature") + ylab("Location") + ggtitle("Boxplot of peaks on Air sensors for Urban settings")
```

```{r}
peaks_air2 %>% mutate(P_location= fct_reorder(P_location, P_temperature)) %>%
  filter(!is.na(P_location) & P_location %in% c("indoor_activities","outdoor_activities")) %>%
  ggplot(aes(P_temperature,P_location)) + geom_boxplot() + xlab("Temperature") + ylab("Location") + ggtitle("Boxplot of peaks on Air sensors for Rural settings")
```


### Skin Sensor

```{r}
knitr::kable(peaks_skin1 %>% group_by(P_location) %>% summarise_each(mean,P_temperature) %>% mutate(Location=P_location,Mean_Temperature=P_temperature) %>% select(Location,Mean_Temperature), caption="Mean Temperature values of peaks for Skin Sensors Urban")
```

```{r}
knitr::kable(peaks_skin2 %>% group_by(P_location) %>% summarise_each(mean,P_temperature) %>% mutate(Location=P_location,Mean_Temperature=P_temperature) %>% select(Location,Mean_Temperature), caption="Mean Temperature values of peaks for Skin Sensors Rural")
```

```{r}
peaks_skin1 %>% mutate(P_location= fct_reorder(P_location, P_temperature)) %>%
  filter(!is.na(P_location) & P_location %in% c("indoor_activities","outdoor_activities")) %>%
  ggplot(aes(P_temperature,P_location)) + geom_boxplot() + xlab("Temperature") + ylab("Location") + ggtitle("Boxplot of peak temperatures on Skin sensors for Urban settings")
```
```{r}
peaks_skin2 %>% mutate(P_location= fct_reorder(P_location, P_temperature)) %>%
  filter(!is.na(P_location) & P_location %in% c("indoor_activities","outdoor_activities")) %>%
  ggplot(aes(P_temperature,P_location)) + geom_boxplot() + xlab("Temperature") + ylab("Location") + ggtitle("Boxplot of peak temperatures on Skin sensors for Rural settings")
```


```{r, echo=FALSE}
ind_air1 <- peaks_air1 %>% filter(P_location=="indoor_activities") %>% mutate(index=as.numeric("1")) %>% group_by(Code_order) %>% summarise_each(sum,index) %>% mutate(location="indoor_activities",settings="Urban",sensor="Air")
colnames(ind_air1)[2] <- "num_of_peaks"
ind_air1<-merge(ind_air1,tempdata_final[,c(2,10)], by="Code_order", all.x=T) %>% distinct()

ind_air2 <- peaks_air2 %>% filter(P_location=="indoor_activities") %>% mutate(index=as.numeric("1")) %>% group_by(Code_order) %>% summarise_each(sum,index) %>% mutate(location="indoor_activities",settings="Rural",sensor="Air")
colnames(ind_air2)[2] <- "num_of_peaks"
ind_air2<-merge(ind_air2,tempdata_final[,c(2,10)], by="Code_order", all.x=T) %>% distinct()

outd_air1 <- peaks_air1 %>% filter(P_location=="outdoor_activities") %>% mutate(index=as.numeric("1")) %>% group_by(Code_order) %>% summarise_each(sum,index) %>% mutate(location="outdoor_activities",settings="Urban",sensor="Air")
colnames(outd_air1)[2] <- "num_of_peaks"
outd_air1<-merge(outd_air1,tempdata_final[,c(2,10)], by="Code_order", all.x=T) %>% distinct()

outd_air2 <- peaks_air2 %>% filter(P_location=="outdoor_activities") %>% mutate(index=as.numeric("1")) %>% group_by(Code_order) %>% summarise_each(sum,index) %>% mutate(location="outdoor_activities",settings="Rural",sensor="Air")
colnames(outd_air2)[2] <- "num_of_peaks"
outd_air2<-merge(outd_air2,tempdata_final[,c(2,10)], by="Code_order", all.x=T) %>% distinct()

total_air <- rbind(ind_air1,ind_air2,outd_air1,outd_air2)
rm(ind_air1,ind_air2,outd_air1,outd_air2)
```


```{r, echo=FALSE}
ind_skin1 <- peaks_skin1 %>% filter(P_location=="indoor_activities") %>% mutate(index=as.numeric("1")) %>% group_by(Code_order) %>% summarise_each(sum,index) %>% mutate(location="indoor_activities",settings="Urban",sensor="Skin")
colnames(ind_skin1)[2] <- "num_of_peaks"
ind_skin1<-merge(ind_skin1,tempdata_final[,c(2,10)], by="Code_order", all.x=T) %>% distinct()

ind_skin2 <- peaks_skin2 %>% filter(P_location=="indoor_activities") %>% mutate(index=as.numeric("1")) %>% group_by(Code_order) %>% summarise_each(sum,index) %>% mutate(location="indoor_activities",settings="Rural",sensor="Skin")
colnames(ind_skin2)[2] <- "num_of_peaks"
ind_skin2<-merge(ind_skin2,tempdata_final[,c(2,10)], by="Code_order", all.x=T) %>% distinct()

outd_skin1 <- peaks_skin1 %>% filter(P_location %in% c("outdoor_activities","outdoor_activities ")) %>% mutate(index=as.numeric("1")) %>% group_by(Code_order) %>% summarise_each(sum,index) %>% mutate(location="outdoor_activities",settings="Urban",sensor="Skin")
colnames(outd_skin1)[2] <- "num_of_peaks"
outd_skin1<-merge(outd_skin1,tempdata_final[,c(2,10)], by="Code_order", all.x=T) %>% distinct()

 
outd_skin2 <- peaks_skin2 %>% filter(P_location=="outdoor_activities") %>% mutate(index=as.numeric("1")) %>% group_by(Code_order) %>% summarise_each(sum,index) %>% mutate(location="outdoor_activities",settings="Rural",sensor="Skin")
colnames(outd_skin2)[2] <- "num_of_peaks"
outd_skin2<-merge(outd_skin2,tempdata_final[,c(2,10)], by="Code_order", all.x=T) %>% distinct()


total_skin <- rbind(ind_skin1,ind_skin2,outd_skin1,outd_skin2)
rm(ind_skin1,ind_skin2,outd_skin1,outd_skin2)
```

```{r, echo=FALSE}
total_air_skin <- rbind(total_air,total_skin)
```


```{r}
ggplot(total_air_skin,aes(x = settings, y = num_of_peaks)) +geom_boxplot(aes(fill=settings)) +  facet_grid(sensor~location, scale="free") + ylim(-1,10) + geom_jitter() + ylab("Number of peaks") + xlab("Settings")
```

```{r, echo=FALSE}
datf <- peaks_air_all %>% filter(P_location=="indoor_activities")
datf <- datf[,c(1:4)]
datfAI <- merge(datf, total_air[,c(1,4:6)],by="Code_order",all.x=T) %>% distinct()

datf2 <- peaks_skin_all %>% filter(P_location=="indoor_activities")
datf2 <- datf2[,c(1:4)]
datfSI <- merge(datf2, total_skin[,c(1,4:6)],by="Code_order",all.x=T) %>% distinct()

datf3 <- peaks_air_all %>% filter(P_location=="outdoor_activities")
datf3 <- datf3[,c(1:4)]
datfAO <- merge(datf3, total_air[,c(1,4:6)],by="Code_order",all.x=T) %>% distinct()

datf4 <- peaks_skin_all %>% filter(P_location=="outdoor_activities")
datf4 <- datf4[,c(1:4)]
datfSO <- merge(datf4, total_skin[,c(1,4:6)],by="Code_order",all.x=T) %>% distinct()

datf <- rbind(datfAI,datfSI,datfAO,datfSO)

ggplot(datf,aes(x = settings, y = P_temperature)) +geom_boxplot(aes(fill=settings)) +  facet_grid(sensor~P_location, scales = "free") + geom_jitter() + ylab("Temperature of Peak") + xlab("Settings")

rm(datf2,datf3,datf4,datfAI,datfSI,datfAO,datfSO)
```

### Summary table of peak temperature per setting on air sensors

`r kable(print(CreateTableOne("P_temperature", data=datf[datf$sensor=="Air",], strata="settings"),testNonNormal = kruskal.test, nonnormal = "P_Temperature"), caption="Summary table of peak temperature by setting for air sensors")`

### Summary table of peak temperature per setting on skin sensors

`r kable(print(CreateTableOne("P_temperature", data=datf[datf$sensor=="Skin",], strata="settings"),testNonNormal = kruskal.test, nonnormal = "P_Temperature"), caption="Summary table of peak temperature by setting for skin sensors")`

### Summary table of number of peaks per setting on air sensors

`r kable(print(CreateTableOne("num", data=air_f, strata="set"),testNonNormal = kruskal.test, nonnormal = "num"), caption="Summary table of number of peaks by setting for air sensor")`

### Summary table of number of peaks per setting on skin sensors

`r kable(print(CreateTableOne("num", data=skin_f, strata="set"),testNonNormal = kruskal.test, nonnormal = "num"), caption="Summary table of number of peaks by setting for skin sensor")`

### Summary table of number of peaks at Indoor/Outdoor location per setting on air sensors

`r kable(print(CreateTableOne("num_of_peaks", data=total_air, strata="settings"),testNonNormal = kruskal.test, nonnormal = "num_of_peaks"), caption="Summary table of number of peaks by setting for air sensor at Indoor/Outdoor location")`

### Summary table of number of peaks at Indoor/Outdoor location per setting on skin sensors

`r kable(print(CreateTableOne("num_of_peaks", data=total_skin, strata="settings"),testNonNormal = kruskal.test, nonnormal = "num_of_peaks"), caption="Summary table of number of peaks by setting for skin sensor at Indoor/Outdoor location")`



## Statistical tests

### AIR PEAK TEMPERATURE DATA

```{r}
wilcox.test(datf[datf$sensor=="Air","P_temperature"]~datf[datf$sensor=="Air","settings"],mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```

```{r}
wilcox.test(datf[datf$sensor=="Air" & datf$set=="Urban","P_temperature"] ~datf[datf$sensor=="Air" & datf$set=="Urban", "P_location"], mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```
```{r}
wilcox.test(datf[datf$sensor=="Air" & datf$settings=="Rural","P_temperature"] ~datf[datf$sensor=="Air" & datf$settings=="Rural", "P_location"], mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```


### SKIN PEAK TEMPERATURE DATA

```{r}
wilcox.test(datf[datf$sensor=="Skin","P_temperature"]~datf[datf$sensor=="Skin","settings"],mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```

```{r}
wilcox.test(datf[datf$sensor=="Skin" & datf$settings=="Urban","P_temperature"] ~datf[datf$sensor=="Skin" & datf$settings=="Urban", "P_location"], mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```

```{r}
wilcox.test(datf[datf$sensor=="Skin" & datf$settings=="Rural","P_temperature"] ~datf[datf$sensor=="Skin" & datf$settings=="Rural", "P_location"], mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```


```{r, include=FALSE}
TNUMAIR <- read.csv("TNUMAIR.csv")
TNUMAIR <- TNUMAIR[!is.na(TNUMAIR$Location),]
TNUMAIR$Location <- as.factor(TNUMAIR$Location)
TNUMAIR[TNUMAIR$Location=="indoor_activities ","Location"] <- "indoor_activities"
TNUMAIR[TNUMAIR$Location=="outdoor_activities ","Location"] <- "outdoor_activities"
TNUMAIR$Location <- factor(TNUMAIR$Location)


TNUMSKIN <- read.csv("TNUMSKIN.csv")
TNUMSKIN <- TNUMSKIN[!is.na(TNUMSKIN$Location),]
TNUMSKIN$Location <- as.factor(TNUMSKIN$Location)
TNUMSKIN[TNUMSKIN$Location=="outdoor_activities ","Location"] <- "outdoor_activities"
TNUMSKIN$Location <- factor(TNUMSKIN$Location)

TNUMSKIN_l <- TNUMSKIN %>% filter(Location %in% c("indoor_activities","outdoor_activities"))
TNUMAIR_l <- TNUMAIR %>% filter(Location %in% c("indoor_activities","outdoor_activities"))

datfa <- datf %>% filter(sensor=="Air")
datfa <- merge(datfa,TNUMAIR[,c(3,6,9)], all.x=T, by.x=c("Code_order","P_time"), by.y=c("Code_order","Time"))

datfs <- datf %>% filter(sensor=="Skin")
datfs <- merge(datfs,TNUMSKIN[,c(3,6,9)], all.x=T, by.x=c("Code_order","P_time"), by.y=c("Code_order","Time"))

datfas <- rbind(datfa, datfs)
rm(datfs,datfa)
```



### CORRELATION TEST BETWEEN PEAK TEMPERATURE AND ACTIVITY

#### URBAN

```{r, warning=F, message=F}
#temp value of peaks ~ activity for Urban
cor.test(datfas[datfas$set=="Urban","P_temperature"],datfas[datfas$set=="Urban","Activity"], method = "spearman")
```
#### RURAL

```{r,warning=F, message=F}
#temp value of peaks ~ activity for Rural
cor.test(datfas[datfas$set=="Rural","P_temperature"],datfas[datfas$set=="Rural","Activity"], method = "spearman")
```


### RAW DATA STATISTICAL TESTS

#### AIR

```{r}
#all temperatures ~ setting(1=Urban, 2=Rural)
wilcox.test(TNUMAIR$Temperature~TNUMAIR$settings,mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```


```{r}
# all temperatures ~ Location (indoor- outdoor) for Urban
wilcox.test(TNUMAIR_l[TNUMAIR_l$settings=="1","Temperature"]~TNUMAIR_l[TNUMAIR_l$settings=="1","Location"],mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```

```{r}
# all temperatures ~ Location (indoor- outdoor) for Rural
wilcox.test(TNUMAIR_l[TNUMAIR_l$settings=="2","Temperature"]~TNUMAIR_l[TNUMAIR_l$settings=="2","Location"],mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```

### SKIN

```{r}
#all temperatures ~ setting(1=Urban, 2=Rural)

wilcox.test(TNUMSKIN$Temperature~TNUMSKIN$settings,mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```

```{r}
# all temperatures ~ Location (indoor- outdoor) for Urban

wilcox.test(TNUMSKIN_l[TNUMSKIN_l$settings=="1","Temperature"]~TNUMSKIN_l[TNUMSKIN_l$settings=="1","Location"],mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```

```{r}
# all temperatures ~ Location (indoor- outdoor) for Rural
wilcox.test(TNUMSKIN_l[TNUMSKIN_l$settings=="2","Temperature"]~TNUMSKIN_l[TNUMSKIN_l$settings=="2","Location"],mu=0, alt="two.sided", conf.int=T, conf.level=0.95, paired=F)
```

```{r}
#correlation between Temperature and Activity for Urban
plot(TNUMSKIN_l$Temperature, TNUMSKIN_l$Activity)
cor.test(TNUMSKIN_l[TNUMSKIN_l$settings=="1","Temperature"],TNUMSKIN_l[TNUMSKIN_l$settings=="1","Activity"], method="spearman", exact=F)
```

```{r}
#correlation between Temperature and Activity for Rural
cor.test(TNUMSKIN_l[TNUMSKIN_l$settings=="2","Temperature"],TNUMSKIN_l[TNUMSKIN_l$settings=="2","Activity"], method="spearman", exact=F)
```

```{r, include=F}
total_air$location <- as.factor(total_air$location)
total_air$location <- relevel(total_air$location, ref="indoor_activities")
total_air$settings <- total_air$set
total_air$settings <- as.factor(total_air$settings)
total_air$settings <- relevel(total_air$settings, ref="Urban")
total_air$set <- NULL
total_air <- tidyr::separate(total_air, Code_order, c("Code", "Order"), sep = "-", remove=F)
total_air <- merge(total_air,bmiage, all.x=T, by="Code")
total_air$Code <- as.factor(total_air$Code)
```

```{r, include=F}
total_skin$location <- as.factor(total_skin$location)
total_skin$location <- relevel(total_skin$location, ref="indoor_activities")
total_skin$settings <- as.factor(total_skin$set)
total_skin$settings <- relevel(total_skin$settings, ref="Urban")
total_skin$set <- NULL
total_skin <- tidyr::separate(total_skin, Code_order, c("Code", "Order"), sep = "-", remove=F)
total_skin <- merge(total_skin, bmiage, all.x=T, by="Code")
total_skin$Code <- as.factor(total_skin$Code)
```

## DTR for Air temperature

```{r, echo=FALSE,  warning=FALSE, message=FALSE}
DTR <- data_air %>% select(Code_order,Temperature,settings) %>% group_by(Code_order) %>% dplyr::summarise(min=min(Temperature), max=max(Temperature)) %>% mutate(dtr=max-min)

DTR_indoor <- TNUMAIR_l %>% filter(Location=="indoor_activities") %>%  select(Code_order,Temperature) %>% group_by(Code_order) %>% dplyr::summarise(min_ind=min(Temperature), max_ind=max(Temperature)) %>% mutate(dtr_ind=max_ind-min_ind)

DTR_outdoor <- TNUMAIR_l %>% filter(Location=="outdoor_activities") %>%  select(Code_order,Temperature) %>% group_by(Code_order) %>% dplyr::summarise(min_out=min(Temperature), max_out=max(Temperature)) %>% mutate(dtr_out=max_out-min_out)

DTR <- merge(DTR,DTR_indoor, all=T, by="Code_order")
DTR <- merge(DTR,DTR_outdoor, all.x=T, by="Code_order")
DTR <- right_join(DTR, data_air[,c(2,9)] , all.x=T, by="Code_order") %>% distinct()

DTR2 <- melt(DTR[,c(4,7,10)])
DTR2$set <- rep(DTR$settings)
DTR2$set <- ifelse(DTR2$set=="1","Urban","Rural")
DTR2 <- na.omit(DTR2)
ggplot(DTR2, aes(x=variable, y=value, fill=set)) + geom_boxplot()
```



## DTR for Skin temperature

```{r, echo=FALSE, warning=FALSE, message=FALSE}
DTRS <- data_skin %>% select(Code_order,Temperature) %>% group_by(Code_order) %>% dplyr::summarise(min=min(Temperature), max=max(Temperature)) %>% mutate(dtr=max-min)

DTRS_indoor <- TNUMSKIN_l %>% filter(Location=="indoor_activities") %>%  select(Code_order,Temperature) %>% group_by(Code_order) %>% dplyr::summarise(min_ind=min(Temperature), max_ind=max(Temperature)) %>% mutate(dtr_ind=max_ind-min_ind)

DTRS_outdoor <- TNUMSKIN_l %>% filter(Location=="outdoor_activities") %>%  select(Code_order,Temperature) %>% group_by(Code_order) %>% dplyr::summarise(min_out=min(Temperature), max_out=max(Temperature)) %>% mutate(dtr_out=max_out-min_out)

DTRS <- merge(DTRS,DTRS_indoor, all=T, by="Code_order")
DTRS <- merge(DTRS,DTRS_outdoor, all.x=T, by="Code_order")


DTRS2 <- melt(DTRS[,c(4,7,10)])
DTRS2 <- na.omit(DTRS2)
ggplot(DTRS2, aes(x=variable, y=value, fill=variable)) + geom_boxplot()
```



### Summary table of DTR by location (Total/Indoor/Outdoor) for Air sensor

`r kable(print(CreateTableOne("value", data=DTR2, strata="variable"),testNonNormal = kruskal.test, nonnormal = "value"), caption="Summary table of DTR by location (Total/Indoor/Outdoor)")`

`r kable(print(CreateTableOne("value", data=DTR2[DTR2$set=="Urban",], strata="variable"),testNonNormal = kruskal.test, nonnormal = "value"), caption="Summary table of DTR by location (Total/Indoor/Outdoor)")`

`r kable(print(CreateTableOne("value", data=DTR2[DTR2$set=="Rural",], strata="variable"),testNonNormal = kruskal.test, nonnormal = "value"), caption="Summary table of DTR by location (Total/Indoor/Outdoor)")`

### Summary table of DTR by location (Total/Indoor/Outdoor) for Skin sensor

`r kable(print(CreateTableOne("value", data=DTRS2, strata="variable"),testNonNormal = kruskal.test, nonnormal = "value"), caption="Summary table of DTR by location (Total/Indoor/Outdoor)")`


```{r, include=F}
TNUMAIR_l$Location <- factor(TNUMAIR_l$Location)
TNUMAIR_l$Location <- relevel(TNUMAIR_l$Location, ref="indoor_activities")
TNUMAIR_l$Code <- as.factor(TNUMAIR_l$Code)
TNUMAIR_l$settings <- ifelse(TNUMAIR_l$settings=="1","Urban","Rural")
TNUMAIR_l$settings <- as.factor(TNUMAIR_l$settings)
TNUMAIR_l$settings <- relevel(TNUMAIR_l$settings, ref="Urban")
TNUMAIR_l <- merge(TNUMAIR_l,bmiage, all.x=T,by="Code")
TNUMAIR_l$logTemperature <- scale(log(TNUMAIR_l$Temperature))

```

```{r, include=F}
TNUMSKIN_l$Location <- factor(TNUMSKIN_l$Location)
TNUMSKIN_l$Location <- relevel(TNUMSKIN_l$Location, ref="indoor_activities")
TNUMSKIN_l$Code <- as.factor(TNUMSKIN_l$Code)
TNUMSKIN_l$settings <- ifelse(TNUMSKIN_l$settings=="1","Urban","Rural")
TNUMSKIN_l$settings <- as.factor(TNUMSKIN_l$settings)
TNUMSKIN_l$settings <- relevel(TNUMSKIN_l$settings, ref="Urban")
TNUMSKIN_l <- merge(TNUMSKIN_l, bmiage, all.x=T, by="Code")
TNUMSKIN_l$logTemperature <- scale(log(TNUMSKIN_l$Temperature))
TNUMSKIN_l$Activity_Group <- ifelse(TNUMSKIN_l$Activity==0,"No_Activity","Any_Activity")
TNUMSKIN_l$Activity_Group <- as.factor(TNUMSKIN_l$Activity_Group)
```

### Summary table for ambient air temperature by setting taking in account all observations

`r kable(print(CreateTableOne("Temperature", data=TNUMAIR_l, strata="Location"),testNonNormal = kruskal.test, nonnormal = "Temperature"), caption="Summary table of ambient air temperature by setting")`

### Summary table for skin temperature by setting taking in account all observations

`r kable(print(CreateTableOne("Temperature", data=TNUMSKIN_l, strata="Location"),testNonNormal = kruskal.test, nonnormal = "Temperature"), caption="Summary table of skin temperature by setting")`

### Summary table of cumulative activity by settting based on skin sensors

`r kable(print(CreateTableOne("Activity", data=TNUMSKIN_l, strata="Location"),testNonNormal = kruskal.test, nonnormal = "Activity"), caption="Summary table of cumulative activity per day based on skin sensors") `

### Summary table of peak temperature per setting on air sensors

`r kable(print(CreateTableOne("P_temperature", data=datf[datf$sensor=="Air",], strata="P_location"),testNonNormal = kruskal.test, nonnormal = "P_Temperature"), caption="Summary table of peak temperature by setting for air sensors")`

### Summary table of peak temperature per setting on skin sensors

`r kable(print(CreateTableOne("P_temperature", data=datf[datf$sensor=="Skin",], strata="P_location"),testNonNormal = kruskal.test, nonnormal = "P_Temperature"), caption="Summary table of peak temperature by setting for skin sensors")`


### Summary table of number of peaks at Indoor/Outdoor location per setting on air sensors

`r kable(print(CreateTableOne("num_of_peaks", data=total_air, strata="location"),testNonNormal = kruskal.test, nonnormal = "num_of_peaks"), caption="Summary table of number of peaks by setting for air sensor at Indoor/Outdoor location")`

### Summary table of number of peaks at Indoor/Outdoor location per setting on skin sensors

`r kable(print(CreateTableOne("num_of_peaks", data=total_skin, strata="location"),testNonNormal = kruskal.test, nonnormal = "num_of_peaks"), caption="Summary table of number of peaks by setting for skin sensor at Indoor/Outdoor location")`


### MODELS

#### Reference for Location is "indoor_activities" and "Urban" for setting for all 4 dataframes


```{r models 1, warning=FALSE, message=FALSE}
model_LSBA <-  glmer(Location ~ settings + BMI + Age + Sex + logTemperature + (1|Code),data= TNUMAIR_l, family = binomial(link="logit"),   control=glmerControl(optimizer = "bobyqa"))

model_S_LSAAB <- glmer(Location ~ settings + BMI + Age + Sex + logTemperature + Activity_Group +   (1|Code),data= TNUMSKIN_l, family = binomial(link="logit"),   control=glmerControl(optimizer = "bobyqa"))

tab_model(model_LSBA, model_S_LSAAB, digits=3, title="Mixed Effect Models for Location~ Settings + BMI + Age + Temperature + Activity(for skin sensor) + random(Participant) for raw data air and skin sensor")
```

```{r models 2,warning=FALSE, message=FALSE}

model_S_LB22 <- glmer(location ~ settings + num_of_peaks + Age + BMI + Sex + (1|Code),data= total_air, family = binomial(link="logit"),   control=glmerControl(optimizer = "bobyqa"), na.action = na.omit)


model_S_LB2 <- glmer(location ~ settings + num_of_peaks + Age + BMI + Sex + (1|Code),data= total_skin, family = binomial(link="logit"),   control=glmerControl(optimizer = "bobyqa"), na.action = na.omit)

tab_model(model_S_LB22, model_S_LB2, digits= 3, title= "Mixed effect models for Location ~ Setting + Number of peaks + Age + BMI  + random(Participant) for number of peaks data for Air and Skin sensor")
```

```{r models 3, warning=FALSE, message=FALSE}
model_LTS <- glmer(Location ~ logTemperature + settings + logTemperature*settings + (1|Code),data= TNUMAIR_l, family = binomial)

model_S_LTS <- glmer(Location ~ logTemperature + settings + logTemperature*settings + (1|Code),data= TNUMSKIN_l, family = binomial)

tempmodels <- c(model_LTS,model_S_LTS)

tab_model(tempmodels, digits = 3, title = "Mixed effect models for Location ~ Temperature + setting + interaction Temperature:setting + random(Participant) for raw data Air and Skin sensor")
```

```{r models 4, warning=FALSE, message=FALSE}
model_tempU <- glmer(Location ~ logTemperature + (1|Code),data= TNUMAIR_l[TNUMAIR_l$settings=="Urban",], family = binomial)

model_tempR <- glmer(Location ~ logTemperature + (1|Code),data= TNUMAIR_l[TNUMAIR_l$settings=="Rural",], family = binomial)

model_tempUS <- glmer(Location ~ logTemperature + (1|Code),data= TNUMSKIN_l[TNUMSKIN_l$settings=="Urban",], family = binomial)

model_tempRS <- glmer(Location ~ logTemperature + (1|Code),data= TNUMSKIN_l[TNUMSKIN_l$settings=="Rural",], family = binomial)

tab_model(model_tempU, model_tempR, model_tempUS, model_tempRS, digits = 3, title = "Mixed effect models for Location ~ Temperature + random(Participant) per Sensor(Air/Skin) and per setting(Urban/Rural)")
```




